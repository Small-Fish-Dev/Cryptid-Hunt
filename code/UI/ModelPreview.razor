@using Sandbox;
@using Sandbox.UI;
@namespace CryptidHunt

<root>
</root>

@code
{
    ScenePanel scenePanel;
    bool dragging = false;
    Vector2 dragPosition;
    Rotation startRotation;
    public ModelRenderer Model => scenePanel.RenderScene.Components.GetAll<ModelRenderer>().FirstOrDefault();
    public CameraComponent Camera => scenePanel.RenderScene.Components.GetAll<CameraComponent>().FirstOrDefault();
    public Vector3 Offset { get; set; } = Vector3.Backward * 100f;

    public override void Tick()
    {
        base.Tick();

        if (scenePanel == null )
        {
            scenePanel = new ScenePanel("scenes/viewer.scene");
            AddChild(scenePanel);
            scenePanel.SetClass("view", true);
        }

        if ( dragging )
        {
            var difference = MousePosition - dragPosition;
            Model.WorldRotation = startRotation * Rotation.FromYaw(difference.x) * Rotation.FromPitch(-difference.y);
        }

        if ( Camera.IsValid() )
        {
            Camera.WorldPosition = Offset;
        }
    }

    public override void OnButtonEvent(ButtonEvent e)
    {
        base.OnButtonEvent(e);

        if ( e.Button == "mouseleft" )
        {
            if ( e.Pressed )
            {
                dragging = true;
                startRotation = Model.WorldRotation;
                dragPosition = MousePosition;
            }
            else
            {
                dragging = false;
            }
        }
    }

    protected override int BuildHash() => System.HashCode.Combine(Time.Now);
}
